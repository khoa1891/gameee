<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Game with Phaser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
</head>

<body>
    <script>
        class MainScene extends Phaser.Scene {
    constructor() {
        super('MainScene');
    }

    preload() {
        this.load.plugin(
            'rexvirtualjoystickplugin',
            'https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexvirtualjoystickplugin.min.js',
            true
        );
    }

    create() {
        // Khởi tạo nhân vật
        this.player = this.add.circle(250, 250, 20, 0x3498db);
        this.physics.add.existing(this.player);
        this.player.body.setCollideWorldBounds(true);
        
        // Tạo quái vật
        this.enemies = this.physics.add.group();
        this.createEnemy(100, 100, 10);
        this.createEnemy(400, 200, 15);
        this.createEnemy(300, 350, 17);

        // Điểm và joystick
        this.score = 5; // Ban đầu có 5 điểm
        this.scoreText = this.add.text(20, 20, `Score: ${this.score}`, {
            font: '24px Arial',
            fill: '#000',
        });

        // Nút bắn
        this.input.on('pointerdown', this.shoot, this);

        // Tạo đạn
        this.bullets = this.physics.add.group({
            classType: Phaser.GameObjects.Circle,
            runChildUpdate: true,
        });

        // Quái vật di chuyển
        this.enemies.getChildren().forEach(enemy => {
            enemy.setVelocity(Phaser.Math.Between(-100, 100), Phaser.Math.Between(-100, 100));
            this.add.text(enemy.x, enemy.y - 30, `${enemy.health}`, { font: '16px Arial', fill: '#000' }).setOrigin(0.5);
        });

        // Tạo các lá
        this.leaves = this.physics.add.group();
        this.createLeaf('green');

        // Cập nhật thời gian
        this.totalSeconds = 0;
        this.timeText = this.add.text(this.cameras.main.width - 100, 10, '00:00', {
            font: '24px Arial',
            fill: '#000',
        }).setOrigin(1, 0);

        this.time.addEvent({
            delay: 1000,
            callback: this.updateTime,
            callbackScope: this,
            loop: true,
        });
    }

    update() {
        this.scoreText.setText(`Score: ${this.score}`);
    }

    createLeaf(type) {
        const color = type === 'green' ? 0x2ecc71 : 0xf1c40f;
        const leaf = this.add.circle(Phaser.Math.Between(20, 480), Phaser.Math.Between(20, 480), 15, color);
        this.physics.add.existing(leaf);
        leaf.type = type;
        this.leaves.add(leaf);
    }

    shoot(pointer) {
        if (this.score <= 0) return; // Không bắn nếu điểm = 0

        // Tính toán hướng bắn
        let dx = pointer.x - this.player.x;
        let dy = pointer.y - this.player.y;
        let angle = Math.atan2(dy, dx);

        // Tạo đạn
        const bullet = this.bullets.get(this.player.x, this.player.y, 15, 0xffffff);
        bullet.setVelocity(Math.cos(angle) * 300, Math.sin(angle) * 300);
        this.score--; // Giảm điểm mỗi lần bắn
    }

    createEnemy(x, y, health) {
        const enemy = this.add.circle(x, y, 20, 0x8e44ad); // Màu nâu
        this.physics.add.existing(enemy);
        enemy.setCollideWorldBounds(true);
        enemy.health = health;

        // Hiển thị số máu trên đầu quái vật
        const healthText = this.add.text(x, y - 30, `${enemy.health}`, { font: '16px Arial', fill: '#fff' });
        healthText.setOrigin(0.5);
        enemy.healthText = healthText;

        this.enemies.add(enemy);
    }

    // Kiểm tra va chạm giữa đạn và quái vật
    updateBullet() {
        this.bullets.children.iterate(bullet => {
            if (!bullet.active) return;

            // Kiểm tra va chạm với quái vật
            this.enemies.children.iterate(enemy => {
                if (Phaser.Math.Distance.Between(bullet.x, bullet.y, enemy.x, enemy.y) < 20) {
                    this.hitEnemy(bullet, enemy);
                    bullet.setActive(false).setVisible(false); // Xóa đạn
                }
            });
        });
    }

    hitEnemy(bullet, enemy) {
        // Ghi lại sát thương đã bắn
        let damage = 1; // Đạn bắn gây 1 sát thương
        enemy.health -= damage;

        // Cập nhật số máu trên đầu quái vật
        enemy.healthText.setText(`${enemy.health}`);

        // Hiệu ứng khi trúng đạn
        this.tweens.add({
            targets: enemy,
            alpha: 0.5,
            yoyo: true,
            duration: 200,
            onComplete: () => {
                if (enemy.health <= 0) {
                    enemy.setActive(false).setVisible(false); // Xóa quái vật khi chết
                    enemy.healthText.setVisible(false);
                }
            }
        });
    }

    updateTime() {
        this.totalSeconds++;
        const minutes = String(Math.floor(this.totalSeconds / 60)).padStart(2, '0');
        const seconds = String(this.totalSeconds % 60).padStart(2, '0');
        this.timeText.setText(`${minutes}:${seconds}`);
    }
}

    </script>
</body>

</html>
