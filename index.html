<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Game with Phaser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <style>
        /* T√πy ch·ªânh c√°c n√∫t b·∫Øn */
        .shoot-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px;
            font-size: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;

            /* bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 18px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer; */
        }
    </style>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
        }



        #messageBox {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 300px;
            background-color: #000;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        #messageBox h3 {
            font-size: 18px;
            text-align: center;
            margin: 0;
        }

        #okButton {
            margin-top: 15px;
            background-color: #ff0000;
            color: #fff;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #okButton:hover {
            background-color: #cc0000;
        }
    </style>
    <link rel="stylesheet" href="css/menu.css">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

</head>

<body>
    <button class="shoot-btn">Shoot</button>
    <!-- Th√¥ng b√°o -->
    <div id="messageBox">
        <h3 id="messageText"></h3>
        <button id="okButton">OK</button>
    </div>


    <!-- menu -->
    <div id="menuButton" class="ui-button">Menu</div>
<div id="inventoryBox" class="ui-box">
    <!-- <div id="inventory"> -->
        <p id="inventoryText">T√∫i ƒê·ªì:<br>
        <p id="n√≥nCount2" class="count2Btn">üî´ N√≥n: <span id="n√≥nCount">0</span></p>
        <p id="gi√°pCount2" class="count2Btn">üé© Gi√°p: <span id="gi√°pCount">0</span></p>
        <p id="ƒë·∫°nCount2" class="count2Btn">üõ°Ô∏è ƒê·∫°n: <span id="ƒë·∫°nCount">0</span></p>
    </div>
    
</div>

<!-- B·∫£ng x√°c nh·∫≠n s·ª≠ d·ª•ng m√≥n ƒë·ªì -->
<div id="confirmationBox" class="ui-box" style="display: none;">
    <p id="confirmationText">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën s·ª≠ d·ª•ng m√≥n ƒë·ªì n√†y?</p>
    <button id="confirmUse">ƒê·ªìng √Ω</button>
    <button id="cancelUse">H·ªßy</button>
</div>


    <script>
        class MainScene extends Phaser.Scene {
            constructor() {
                super('MainScene');
            }

            preload() {
                this.load.plugin(
                    'rexvirtualjoystickplugin',
                    'https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexvirtualjoystickplugin.min.js',
                    true
                );
            }

            create() {
                // M·∫£ng c√°c m√≥n qu√†
                this.gifts = [
                    'n√≥n', 'gi√°p', 'ƒë·∫°n'
                ];
                this.mapWidth = 5000
                this.mapHeight = 5000
                // T·∫°o b·∫£n ƒë·ªì (h√¨nh ch·ªØ nh·∫≠t)
                this.map = this.add.rectangle(0, 0, this.mapWidth, this.mapHeight, 0xffa500);
                this.map.setOrigin(0);
                this.physics.world.setBounds(0, 0, this.mapWidth, this.mapHeight);

                // T·∫°o ng∆∞·ªùi ch∆°i
                this.player = this.add.circle(250, 250, 20, 0x3498db);
                this.physics.add.existing(this.player);
                this.player.body.setCollideWorldBounds(true);

                // B·∫≠t camera theo d√µi nh√¢n v·∫≠t
                this.cameras.main.startFollow(this.player, true, 0.08, 0.08);
                // 2. CƒÉn Gi·ªØa Nh√¢n V·∫≠t
                // ƒê·ªÉ nh√¢n v·∫≠t lu√¥n ·ªü gi·ªØa m√†n h√¨nh:

                this.cameras.main.setBounds(0, 0, this.mapWidth, this.mapHeight);

                // B·∫≠t camera theo d√µi nh√¢n v·∫≠t, nh∆∞ng gi·ªõi h·∫°n ch·ªâ trong ph·∫°m vi m√† b·∫°n mu·ªën
                // T·∫°o v√πng nh√¨n vu√¥ng cho camera
                // this.cameras.main.setViewport(100, 100, 500, 500);  // (x, y, width, height)

                // this.cameras.main.setZoom(1);  // ƒêi·ªÅu ch·ªânh zoom c·ªßa camera (c√†ng nh·ªè zoom, khu v·ª±c xem s·∫Ω c√†ng r·ªông)

                // Nh√≥m l√°
                this.leaves = this.physics.add.group();
                this.createLeaf('green');

                // s·∫•m
                // this.hasƒê·∫°n = false;      // K√≠ch ho·∫°t s·∫•m
this.thunderAttacks = 0;           // S·ªë l·∫ßn s·∫•m ƒë√°nh
this.thunderMaxAttacks = 3;        // Gi·ªõi h·∫°n s·ªë l·∫ßn
this.thunderDuration = 7;          // Th·ªùi gian t·ªìn t·∫°i
this.thunderInterval = 1500;       // Th·ªùi gian m·ªói ƒë·ª£t s·∫•m (1,5 gi√¢y)


                // T·∫°o joystick
                this.joystickBase = this.add.circle(100, this.cameras.main.height - 100, 50, 0x000000, 0.3).setInteractive();
                this.joystick = this.add.circle(100, this.cameras.main.height - 100, 25, 0xffffff, 0.5).setInteractive();
                this.physics.add.overlap(this.player, this.leaves, this.collectLeaf, null, this);
                // ƒê·∫£m b·∫£o joystick lu√¥n c·ªë ƒë·ªãnh tr√™n m√†n h√¨nh
                this.joystickBase.setScrollFactor(0);  // Kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi camera
                this.joystick.setScrollFactor(0);  // Kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi camera

                // Hi·ªÉn th·ªã ƒëi·ªÉm
                this.score = 0;
                this.greenLeafCount = 0;
                this.scoreText = this.add.text(this.player.x, this.player.y - 40, 'üü¢ 0', {
                    font: '24px Arial',
                    fill: '#000',
                }).setOrigin(0.5);

                // Th·ªùi gian
                this.totalSeconds = 0;
                // this.scale.width - 120, this.cameras.main.width - 100
                this.timeText = this.add.text(this.scale.width - 120, 10, '00:00', {
                    font: '24px Arial',
                    fill: '#000',
                }).setOrigin(1, 0);
                // ƒê·∫£m b·∫£o th·ªùi gian lu√¥n c·ªë ƒë·ªãnh tr√™n m√†n h√¨nh
                this.timeText.setScrollFactor(0);  // Kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi camera

                // ƒê·∫øm th·ªùi gian
                this.time.addEvent({
                    delay: 1000,
                    callback: this.updateTime,
                    callbackScope: this,
                    loop: true,
                });

                // L√° v√†ng xu·∫•t hi·ªán m·ªói 17 gi√¢y
                this.time.addEvent({
                    delay: 17000,
                    callback: () => this.createLeaf('yellow'),
                    loop: true,
                });

                // ƒêi·ªÅu khi·ªÉn joystick
                this.input.on('pointermove', this.handleJoystickMove, this);
                this.input.on('pointerup', this.resetJoystick, this);

                // T·∫°o qu√°i v·∫≠t
                // this.enemies = this.physics.add.group();
                this.enemies = this.physics.add.group({
                    bounceX: 1,
                    bounceY: 1,
                    collideWorldBounds: true // B·∫≠t va ch·∫°m bi√™n
                });

                this.createEnemy(100, 100, 2);
                this.createEnemy(400, 200, 12);
                this.createEnemy(300, 350, 17);
                // L·∫Øng nghe ph√≠m 'B' ƒë·ªÉ di chuy·ªÉn qu√°i v·∫≠t
                this.input.keyboard.on('keydown-B', this.moveEnemy, this);

                // N√∫t b·∫Øn
                this.shootBtn = document.querySelector('.shoot-btn');
                this.shootBtn.addEventListener('click', this.shoot.bind(this));
                // ƒê√≥ng b·∫£ng th√¥ng b√°o khi nh·∫•n n√∫t "OK"
                this.messageBox = document.getElementById('messageBox');
                this.messageText = document.getElementById('messageText');
                this.okButton = document.getElementById('okButton');
                this.okButton.addEventListener('click', () => {
                    this.messageBox.style.display = 'none'; // ·∫®n th√¥ng b√°o
                });

                // T·∫°o ƒë·∫°n
                this.bullets = this.physics.add.group({
                    classType: Phaser.Physics.Arcade.Image,
                    runChildUpdate: true,
                });


                // Ki·ªÉm tra va ch·∫°m ƒë·∫°n v·ªõi qu√°i v·∫≠t
                this.physics.add.collider(this.bullets, this.enemies, this.hitEnemy, null, this);

                // Th√™m thu·ªôc t√≠nh b·∫£o v·ªá v√† b·ªô ƒë·∫øm th·ªùi gian
                this.hasGi√°p = false;
                this.hasN√≥n = false;
                this.hasƒê·∫°n = false
                this.lastHitTime = 0; // L·∫ßn cu·ªëi b·ªã qu√°i t·∫•n c√¥ng

        //          // T·∫°o b·∫£ng t√∫i ƒë·ªì (·∫©n ban ƒë·∫ßu)
        //          this.widthBag = 200
        //          this.heightBag = 200
        // this.inventoryBox = this.add.rectangle(this.widthBag  / 2, this.heightBag  / 2, 300, 200, 0x555555);
        // this.inventoryBox.setStrokeStyle(4, 0xffffff);
        // this.inventoryBox.setVisible(false);

        // // T·∫°o vƒÉn b·∫£n trong t√∫i ƒë·ªì
        // this.inventoryText = this.add.text(
        //     this.widthBag  / 2 - 130,
        //     this.heightBag  / 2 - 80,
        //     "T√∫i ƒê·ªì:\n\nüî´ ƒê·∫°n: 0\nüé© N√≥n: 0\nüõ°Ô∏è Gi√°p: 0",
        //     { font: '20px Arial', fill: '#fff' }
        // );
        // this.inventoryText.setVisible(false);

       
         // L·∫•y ph·∫ßn t·ª≠ HTML
    this.menuButton = document.getElementById("menuButton");
    this.inventoryBox = document.getElementById("inventoryBox");
    this.inventoryText = document.getElementById("inventoryText");

    // Bi·∫øn l∆∞u s·ªë l∆∞·ª£ng v·∫≠t ph·∫©m
    this.inventory = {
        ƒë·∫°n: 1,
        n√≥n: 1,
        gi√°p: 1,
    };

    // S·ª± ki·ªán nh·∫•n n√∫t Menu
    this.menuButton.addEventListener("click", () => {
        const isVisible = this.inventoryBox.style.display === "block";
        this.inventoryBox.style.display = isVisible ? "none" : "block";
        if (!isVisible) this.updateInventoryText();
    });

    

                // Va ch·∫°m qu√°i v·∫≠t v√† nh√¢n v·∫≠t
                // this.physics.add.collider(this.player, this.enemies, (player, enemy) => {
                //     const currentTime = this.time.now;
                //     if (currentTime - this.lastHitTime > 500) { // 500ms gi·ªØa c√°c l·∫ßn tr·ª´ m√°u
                //         if (!this.hasGi√°p) {
                //             this.score = Math.max(this.score - 2, 0); // Tr·ª´ 2 ƒë·∫°n, kh√¥ng √¢m
                //             this.scoreText.setText(`${this.score}`);
                //         }
                //         if (this.hasN√≥n) {
                //             enemy.health -= 5; // Gi·∫£m m√°u qu√°i n·∫øu c√≥ n√≥n
                //             enemy.healthText.setText(`${enemy.health > 0 ? enemy.health : 0}`);
                //             if (enemy.health <= 0) {
                //                 this.hitEnemy(null, enemy); // H·∫° qu√°i
                //             }
                //             this.hasN√≥n = false; // N√≥n m·∫•t sau va ch·∫°m
                //         }
                //         this.lastHitTime = currentTime; // C·∫≠p nh·∫≠t th·ªùi gian b·ªã ƒë√°nh g·∫ßn nh·∫•t
                //     }
                // });

                this.physics.add.collider(this.player, this.enemies, (player, enemy) => {
                    const currentTime = this.time.now;
                    if (currentTime - this.lastHitTime > 500) { // 500ms gi·ªØa c√°c l·∫ßn tr·ª´ m√°u
                        console.log(this.score)
                        if (!this.hasGi√°p) {
                            this.isProtected ? 0 : this.score = Math.max(this.score - 2, 0);
                            this.scoreText.setText(`${this.score}`);
                        console.log(this.score)

                        }

                        // if (this.hasN√≥n) {
                        //     enemy.health -= 5;
                        //     this.score += 2
                        //     this.scoreText.setText(`${this.score}`);
                

                        //     enemy.healthText.setText(`${enemy.health > 0 ? enemy.health : 0}`);
                        //     if (enemy.health <= 0) {
                        //         this.hitEnemy(null, enemy);
                        //     }
                        //     this.hasN√≥n = false;
                        // }

                        // T√≠nh h∆∞·ªõng vƒÉng 
                        const dx = enemy.x - player.x;
                        const dy = enemy.y - player.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        // ƒêi·ªÅu ch·ªânh v·∫≠n t·ªëc cho qu√°i vƒÉng nh·∫π
                        const force = 20; // Gi·∫£m gi√° tr·ªã n√†y ƒë·ªÉ vƒÉng nh·∫π h∆°n
                        enemy.body.setVelocity((dx / distance) * force, (dy / distance) * force);
                        enemy.body.setDrag(200); // Gi·∫£m t·ªëc t·ª´ t·ª´
                        this.lastHitTime = currentTime;
                    }
                    if (this.isProtected) {
        // enemy.health -= 5;
        // enemy.healthText.setText(enemy.health);
        this.hitEnemy(0, enemy, 0)

        // K·∫øt th√∫c hi·ªáu ·ª©ng
        this.isProtected = false;
        // this.player.clearTint();
        this.player.fillColor = 0x3498db
        this.timeBar.clear();
        // this.timeBarContainer.clear();
    } else {
        // M·∫•t ƒë·∫°n khi kh√¥ng b·∫£o v·ªá
        this.inventory.ammo--;
        document.getElementById('ƒë·∫°nCount').innerText = this.inventory.ammo;
    }


                });


                // T·∫°o ƒë·ªëi t∆∞·ª£ng `CursorKeys` ƒë·ªÉ ki·ªÉm tra c√°c ph√≠m di chuy·ªÉn
// this.cursors = this.input.keyboard.createCursorKeys();
                // Thay ƒë·ªïi t·ªëc ƒë·ªô v·ªõi acceleration
this.player.body.setAcceleration(100); // Th√™m gia t·ªëc
// C·∫•u h√¨nh v·∫≠t l√Ω
this.player.body.setDrag(0.5, 0.5); // Gi·∫£m t·ªëc ƒë·ªô t·ª´ t·ª´
this.player.body.setMaxVelocity(200); // T·ªëi ƒëa t·ªëc ƒë·ªô

// Khi nh·∫•n v√†o m·ªôt m√≥n ƒë·ªì trong t√∫i ƒë·ªì
document.getElementById('n√≥nCount2').addEventListener('click', () => {
    if (this.inventory.n√≥n > 0) {
        this.showConfirmation('n√≥n');
    } else {
        this.checkItemAlert('n√≥n', this.inventory.n√≥n);
    }
});

document.getElementById('gi√°pCount2').addEventListener('click', () => {
    if (this.inventory.gi√°p > 0) {
        this.showConfirmation('gi√°p');
    } else {
        this.checkItemAlert('gi√°p', this.inventory.gi√°p());
    }
});

document.getElementById('ƒë·∫°nCount2').addEventListener('click', () => {
    if (this.inventory.n√≥n > 0) {
        this.showConfirmation('ƒë·∫°n');
    } else {
        this.checkItemAlert('n√≥n', this.inventory.n√≥n());

    }
});


// -------------------- thanh tgian
// Bi·∫øn tr·∫°ng th√°i
this.isProtected = false;

// T·∫°o thanh th·ªùi gian tr√™n ƒë·∫ßu nh√¢n v·∫≠t
this.timeBar = this.add.graphics();
this.timeBar.setDepth(2)
// this.timeBarContainer = this.add.graphics();


// K√≠ch th∆∞·ªõc thanh th·ªùi gian
this.timeBarWidth = 60;
this.timeBarHeight = 8;



    // -------------end

            }

             // H√†m b·∫≠t/t·∫Øt b·∫£ng t√∫i ƒë·ªì
    // toggleInventory() {
    //     const isVisible = this.inventoryBox.visible;

    //     // ƒê·ªïi tr·∫°ng th√°i hi·ªÉn th·ªã
    //     this.inventoryBox.setVisible(!isVisible);
    //     this.inventoryText.setVisible(!isVisible);

    //     // C·∫≠p nh·∫≠t n·ªôi dung b·∫£ng
    //     if (!isVisible) {
    //         this.updateInventoryText();
    //     }
    // }

    // // C·∫≠p nh·∫≠t n·ªôi dung t√∫i ƒë·ªì
    // updateInventoryText() {
    //     this.inventoryText.setText(
    //         `T√∫i ƒê·ªì:\n\nüî´ ƒê·∫°n: ${this.inventory.bullet}\nüé© N√≥n: ${this.inventory.helmet}\nüõ°Ô∏è Gi√°p: ${this.inventory.armor}`
    //     );
    // }
    // C·∫≠p nh·∫≠t vƒÉn b·∫£n T√∫i ƒê·ªì
updateInventoryText() {
    document.getElementById('n√≥nCount').innerHTML = this.inventory.n√≥n
    document.getElementById('gi√°pCount').innerHTML = this.inventory.gi√°p
    document.getElementById('ƒë·∫°nCount').innerHTML = this.inventory.ƒë·∫°n
   
}


            createLootBox(enemy) {
                // T·∫°o h√≤m qu√† khi qu√°i ch·∫øt
                const lootBox = this.add.rectangle(enemy.x, enemy.y, 50, 30, 0x00ff00);  // M√†u xanh l√°
                lootBox.setOrigin(0.5);
                lootBox.setInteractive();  // L√†m cho h√≤m qu√† c√≥ th·ªÉ t∆∞∆°ng t√°c

                // Th√™m hi·ªáu ·ª©ng r∆°i cho h√≤m qu√†
                this.tweens.add({
                    targets: lootBox,
                    y: lootBox.y + 20,  // R∆°i xu·ªëng d∆∞·ªõi
                    duration: 500,
                    ease: 'Power1'
                });

                // X·ª≠ l√Ω khi ng∆∞·ªùi ch∆°i nh·∫•n v√†o h√≤m qu√†
                lootBox.on('pointerdown', () => {
                    // this.showItemTable();  // G·ªçi h√†m ƒë·ªÉ hi·ªán b·∫£ng item
                    const randomIndex = Math.floor(Math.random() * this.gifts.length);
                    const selectedGift = this.gifts[randomIndex];


// C·ªông v√†o h√†nh trang
this.inventory[selectedGift] += 1;

// C·∫≠p nh·∫≠t giao di·ªán HTML
document.getElementById(`${selectedGift}Count`).innerText = this.inventory[selectedGift];
                    lootBox.destroy()

                    // In ra m√≥n qu√† ƒë√£ ch·ªçn
                    //   console.log("Ch√∫c m·ª´ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c m√≥n qu√†: " + selectedGift);
                    //   ------------------

                    // T·∫°o b·∫£ng th√¥ng b√°o ch√∫c m·ª´ng
                    this.messageText.textContent = `Ch√∫c m·ª´ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c: ${selectedGift}`;
                    this.messageBox.style.display = 'flex'; // Hi·ªÉn th·ªã th√¥ng b√°o



                });
            }
            useHelmet() {
    if (this.inventory.helmet <= 0) return;

    // B·∫≠t b·∫£o v·ªá
    this.isProtected = true;
    // this.hasN√≥n = true
    // this.player.setTint(0xff0000); // ƒê·ªïi m√†u nh√¢n v·∫≠t
    this.player.fillColor = 0xff0000; 

    // V·∫Ω khung thanh th·ªùi gian
    // this.timeBarContainer.clear();
    // this.timeBarContainer.fillStyle(0x333333);
    // this.timeBarContainer.fillRect(
    //     this.player.x -252, 
    //     this.player.y - 252, 
    //     this.timeBarWidth, 
    //     this.timeBarHeight
    // );

    // Kh·ªüi t·∫°o th·ªùi gian ƒë·∫øm ng∆∞·ª£c
    this.timeBar.clear();
    this.timeBar.fillStyle(0xff0000);
    this.remainingTime = 7000; // 7 gi√¢y
};
            update() {
                this.scoreText.setPosition(this.player.x, this.player.y - 40);

    //              // Di chuy·ªÉn nh√¢n v·∫≠t khi nh·∫•n c√°c ph√≠m
    // if (this.cursors.left.isDown) {
    //     this.player.body.setVelocityX(-100);
    // }
    // else if (this.cursors.right.isDown) {
    //     this.player.body.setVelocityX(100);
    // } else {
    //     this.player.body.setVelocityX(0); // D·ª´ng khi kh√¥ng nh·∫•n tr√°i/ph·∫£i
    // }

    // if (this.cursors.up.isDown) {
    //     this.player.body.setVelocityY(-100);
    // }
    // else if (this.cursors.down.isDown) {
    //     this.player.body.setVelocityY(100);
    // } else {
    //     this.player.body.setVelocityY(0); // D·ª´ng khi kh√¥ng nh·∫•n l√™n/xu·ªëng
    // }

    this.enemies.getChildren().forEach(enemy => {
        // C·∫≠p nh·∫≠t v·ªã tr√≠ vƒÉn b·∫£n s·ª©c kh·ªèe
        enemy.healthText.setPosition(enemy.x, enemy.y - 30);

    });
    // ---------------------- thanh tgian
     // C·∫≠p nh·∫≠t v·ªã tr√≠ thanh th·ªùi gian
     if (this.isProtected) {
        // this.timeBarContainer.setPosition(this.player.x - this.timeBarWidth / 2, this.player.y - 50);

        // Gi·∫£m th·ªùi gian
        this.remainingTime -= this.game.loop.delta;
        const percent = Phaser.Math.Clamp(this.remainingTime / 7000, 0, 1);

        // C·∫≠p nh·∫≠t thanh th·ªùi gian
        this.timeBar.clear();
        this.timeBar.fillStyle(0xff0000);
        this.timeBar.fillRect(
            this.player.x - this.timeBarWidth / 2, 
            this.player.y - 50, 
            this.timeBarWidth * percent, 
            this.timeBarHeight
        );

        // H·∫øt th·ªùi gian, t·∫Øt b·∫£o v·ªá
        if (this.remainingTime <= 0) {
            this.isProtected = false;
            // this.player.clearTint();
            this.player.fillColor = 0x3498db
            this.timeBar.clear();
            // this.hasN√≥n = false
            // this.timeBarContainer.clear();
        }
    }

    if (this.hasGi√°p) {
        // this.timeBarContainer.setPosition(this.player.x - this.timeBarWidth / 2, this.player.y - 50);

        // Gi·∫£m th·ªùi gian
        this.remainingTime -= this.game.loop.delta;
        const percent = Phaser.Math.Clamp(this.remainingTime / 7000, 0, 1);

        // C·∫≠p nh·∫≠t thanh th·ªùi gian
        this.timeBar.clear();
        this.timeBar.fillStyle(0x388e3c);
        this.timeBar.fillRect(
            this.player.x - this.timeBarWidth / 2, 
            this.player.y - 50, 
            this.timeBarWidth * percent, 
            this.timeBarHeight
        );

        // H·∫øt th·ªùi gian, t·∫Øt b·∫£o v·ªá
        if (this.remainingTime <= 0) {
            this.hasGi√°p = false;
            // this.player.clearTint();
            this.player.fillColor = 0x3498db
            this.timeBar.clear();
            // this.hasN√≥n = false
            // this.timeBarContainer.clear();
        }
    }

    
    if (this.hasƒê·∫°n) {
        // this.timeBarContainer.setPosition(this.player.x - this.timeBarWidth / 2, this.player.y - 50);

        // Gi·∫£m th·ªùi gian
        this.remainingTime -= this.game.loop.delta;
        const percent = Phaser.Math.Clamp(this.remainingTime / 7000, 0, 1);

        // C·∫≠p nh·∫≠t thanh th·ªùi gian
        this.timeBar.clear();
        this.timeBar.fillStyle(0xA9A9A9);
        this.timeBar.fillRect(
            this.player.x - this.timeBarWidth / 2, 
            this.player.y - 50, 
            this.timeBarWidth * percent, 
            this.timeBarHeight
        );

        // H·∫øt th·ªùi gian, t·∫Øt b·∫£o v·ªá
        if (this.remainingTime <= 0) {
            this.hasƒê·∫°n = false;
            // this.player.clearTint();
            this.player.fillColor = 0x3498db
            this.timeBar.clear();
            // this.hasN√≥n = false
            // this.timeBarContainer.clear();
        }
    }
            }
            moveEnemy() {
                // L·∫•y qu√°i v·∫≠t ƒë·∫ßu ti√™n trong nh√≥m enemies
                let enemy = this.enemies.getChildren()[0];

                if (enemy) {
                    // Di chuy·ªÉn qu√°i v·∫≠t t·ª´ (100, 100) ƒë·∫øn (500, 500)
                    this.tweens.add({
                        targets: enemy,
                        x: 400,
                        y: 400,
                        duration: 200, // Th·ªùi gian di chuy·ªÉn 1 gi√¢y
                        ease: 'Power2'
                    });
                }
            }
            activateThunderSkill() {
    if (this.hasƒê·∫°n) return; // ƒê√£ k√≠ch ho·∫°t th√¨ b·ªè qua
    

    this.hasƒê·∫°n = true;
    this.thunderAttacks = 0;

    this.player.fillColor = 0xA9A9A9

    // Kh·ªüi t·∫°o th·ªùi gian ƒë·∫øm ng∆∞·ª£c
    this.timeBar.clear();
    this.timeBar.fillStyle(0xA9A9A9);
    this.remainingTime = 7000; // 7 gi√¢y

    // T·∫°o v√≤ng tr√≤n k·ªπ nƒÉng quanh nh√¢n v·∫≠t
    const skillRange = this.add.circle(this.player.x, this.player.y, 100, 0x808080, 0.3);
    skillRange.setDepth(1); // ƒê·∫£m b·∫£o ·ªü tr√™n qu√°i

     // G·ªçi ƒë·ª£t ƒë·∫ßu ngay l·∫≠p t·ª©c
     this.thunderStrike();
    // B·∫Øt ƒë·∫ßu ƒë·ª£t t·∫•n c√¥ng
    this.thunderTimer = this.time.addEvent({
        delay: this.thunderInterval, // M·ªói 1,5 gi√¢y
        callback: this.thunderStrike,
        callbackScope: this,
        repeat: this.thunderMaxAttacks - 1,  // 3 l·∫ßn
    });

    // K·∫øt th√∫c k·ªπ nƒÉng sau 7 gi√¢y
    this.time.delayedCall(this.thunderDuration * 1000, () => {
        this.endThunderSkill();
         // X√≥a v√≤ng tr√≤n sau 7 gi√¢y
    
    });
    this.time.delayedCall(7000, () => {
        skillRange.destroy();
    }, [], this);
}
// H√†m s·∫•m t·∫•n c√¥ng:
thunderStrike() {
    const closestEnemy = this.enemies.getChildren().find(enemy => enemy.active);

    if (closestEnemy) {
        // T·∫°o gi·ªçt n∆∞·ªõc
        const drop = this.add.circle(closestEnemy.x, closestEnemy.y - 300, 10, 0x00aaff);
        this.physics.add.existing(drop);
        drop.body.setVelocityY(300);

        // X·ª≠ l√Ω va ch·∫°m
        this.physics.add.overlap(drop, closestEnemy, (drop, enemy) => {
            if (!enemy.active) return;

            enemy.health -= 2;
            enemy.healthText.setText(enemy.health);

            if (enemy.health <= 0) {
                enemy.setActive(false).setVisible(false);
                enemy.healthText.setVisible(false);
            }
            drop.destroy();
        });

        this.thunderAttacks++;

        // C·∫≠p nh·∫≠t thanh th·ªùi gian
        const timeLeft = this.thunderDuration - this.thunderAttacks * (this.thunderInterval / 1000);
        this.timeBar.clear();
        this.timeBar.fillStyle(0x0000ff);
        this.timeBar.fillRect(this.player.x - 40, this.player.y - 60, 80 * (timeLeft / this.thunderDuration), 8);

    } else {
        // N·∫øu kh√¥ng c√≥ qu√°i, l√πi ƒë·ª£t s·∫•m th√™m 500ms v√† th·ª≠ l·∫°i
        this.time.addEvent({
            delay: 500, // Ki·ªÉm tra l·∫°i sau 0,5 gi√¢y
            callback: this.thunderStrike,
            callbackScope: this,
        });
    }

    // K·∫øt th√∫c khi ƒë·ªß 3 ƒë·ª£t ho·∫∑c h·∫øt th·ªùi gian
    if (this.thunderAttacks >= this.thunderMaxAttacks || this.time.now > this.skillEndTime) {
        this.endThunderSkill();
    }
}

// thunderStrike() {
//     const closestEnemy = this.enemies.getChildren().find(enemy => enemy.active);

//     if (closestEnemy) {
//         // Ki·ªÉm tra xem qu√°i c√≥ trong ph·∫°m vi 200px kh√¥ng
//         const distance = Phaser.Math.Distance.Between(this.player.x, this.player.y, closestEnemy.x, closestEnemy.y);
//         const skillRange = 200;  // Ph·∫°m vi k·ªπ nƒÉng (200px)

//         if (distance <= skillRange) {
//             // T·∫°o gi·ªçt n∆∞·ªõc
//             const drop = this.add.circle(closestEnemy.x, closestEnemy.y - 300, 10, 0x00aaff);
//             this.physics.add.existing(drop);
//             drop.body.setVelocityY(300);

//             // X·ª≠ l√Ω va ch·∫°m
//             this.physics.add.overlap(drop, closestEnemy, (drop, enemy) => {
//                 if (!enemy.active) return;

//                 enemy.health -= 2;
//                 enemy.healthText.setText(enemy.health);

//                 if (enemy.health <= 0) {
//                     enemy.setActive(false).setVisible(false);
//                     enemy.healthText.setVisible(false);
//                 }
//                 drop.destroy();
//             });

//             this.thunderAttacks++;

//             // C·∫≠p nh·∫≠t thanh th·ªùi gian
//             const timeLeft = this.thunderDuration - this.thunderAttacks * (this.thunderInterval / 1000);
//             this.timeBar.clear();
//             this.timeBar.fillStyle(0x0000ff);
//             this.timeBar.fillRect(this.player.x - 40, this.player.y - 60, 80 * (timeLeft / this.thunderDuration), 8);
//         }

//     } else {
//         // N·∫øu kh√¥ng c√≥ qu√°i, l√πi ƒë·ª£t s·∫•m th√™m 500ms v√† th·ª≠ l·∫°i
//         this.time.addEvent({
//             delay: 500, // Ki·ªÉm tra l·∫°i sau 0,5 gi√¢y
//             callback: this.thunderStrike,
//             callbackScope: this,
//         });
//     }

//     // K·∫øt th√∫c khi ƒë·ªß 3 ƒë·ª£t ho·∫∑c h·∫øt th·ªùi gian
//     if (this.thunderAttacks >= this.thunderMaxAttacks || this.time.now > this.skillEndTime) {
//         this.endThunderSkill();
//     }
// }

endThunderSkill() {
    this.hasƒê·∫°n = false;

    // X√≥a thanh th·ªùi gian
    this.timeBar.clear();

    // H·ªßy ƒë·ª£t s·∫•m c√≤n l·∫°i
    if (this.thunderTimer) {
        this.thunderTimer.remove(false);
    }
}


            // T·∫°o v·∫≠t ph·∫©m
            createItem(x, y) {
                const item = this.add.rectangle(x, y, 30, 20, 0x2ecc71);
                item.setInteractive();
                item.on('pointerdown', () => {
                    this.showItemMenu(x, y);
                    item.destroy();
                });
            }
            // M·ªü b·∫£ng x√°c nh·∫≠n s·ª≠ d·ª•ng m√≥n ƒë·ªì
showConfirmation = (item) => {
    const confirmationBox = document.getElementById('confirmationBox');
    const confirmationText = document.getElementById('confirmationText');
    confirmationText.textContent = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën s·ª≠ d·ª•ng m√≥n ƒë·ªì: ${item} n√†y?`;

    // Hi·ªÉn th·ªã b·∫£ng x√°c nh·∫≠n
    confirmationBox.style.display = 'block';

    // X·ª≠ l√Ω ƒë·ªìng √Ω s·ª≠ d·ª•ng m√≥n ƒë·ªì
    document.getElementById('confirmUse').onclick = () => {
        if (this.inventory[item] > 0) {
            this.inventory[item]--;
            // this.updateInventory();
            
            if (item == 'n√≥n') {this.useHelmet()}
            else if (item == 'gi√°p') {this.startArmorTimer()}
            else if (item == 'ƒë·∫°n') {this.activateThunderSkill()}
            console.log(`ƒê√£ s·ª≠ d·ª•ng ${item}`);
        }
        confirmationBox.style.display = 'none'; // ·∫®n b·∫£ng x√°c nh·∫≠n
        this.inventoryBox.style.display = 'none'
    };

    // X·ª≠ l√Ω h·ªßy s·ª≠ d·ª•ng m√≥n ƒë·ªì
    document.getElementById('cancelUse').onclick = () => {
        confirmationBox.style.display = 'none'; // ·∫®n b·∫£ng x√°c nh·∫≠n
    };
};




            // Nh·∫∑t v·∫≠t ph·∫©m
            pickItem(name) {
                if (name === 'ƒê·∫°n') {
                    this.score += 5;
                    this.scoreText.setText(`${this.score}`);
                } else if (name === 'Gi√°p') {
                    this.hasGi√°p = true;
                    this.time.delayedCall(12000, () => {
                        this.hasGi√°p = false;
                    });
                } else if (name === 'N√≥n') {
                    this.hasN√≥n = true;
                    this.time.delayedCall(20000, () => {
                        this.hasN√≥n = false;
                    });
                }
            }

            shoot() {
                if (this.score <= 0) return; // Kh√¥ng b·∫Øn n·∫øu kh√¥ng c√≤n ƒë·∫°n

                // T√¨m qu√°i v·∫≠t g·∫ßn nh·∫•t
                let closestEnemy = null;
                let minDistance = Infinity;

                this.enemies.getChildren().forEach(enemy => {
                    let distance = Phaser.Math.Distance.Between(this.player.x, this.player.y, enemy.x, enemy.y);
                    if (distance < minDistance && distance < 200) { // Gi·ªõi h·∫°n kho·∫£ng c√°ch
                        minDistance = distance;
                        closestEnemy = enemy;
                    }
                });

                if (closestEnemy) {
                    let dx = closestEnemy.x - this.player.x;
                    let dy = closestEnemy.y - this.player.y;
                    let angle = Math.atan2(dy, dx);

                    // T·∫°o ƒë·∫°n
                    const bullet = this.add.circle(this.player.x, this.player.y, 5, 0x8e44ad); // ƒê·∫°n m√†u n√¢u
                    this.physics.add.existing(bullet);
                    bullet.body.setVelocity(Math.cos(angle) * 300, Math.sin(angle) * 300);

                    // Ki·ªÉm tra va ch·∫°m ƒë·∫°n v·ªõi qu√°i v·∫≠t
                    this.physics.add.collider(bullet, closestEnemy, (bullet, enemy) => {
                        this.hitEnemy(bullet, enemy); // G·ªçi h√†m x·ª≠ l√Ω khi ƒë·∫°n ch·∫°m qu√°i
                    });

                    this.score--; // Gi·∫£m s·ªë ƒë·∫°n
                    this.scoreText.setText(`${this.score}`);
                }
            }

            // Thanh th·ªùi gian cho gi√°p (7 gi√¢y)
startArmorTimer() {
    this.hasGi√°p = true
    let timeLeft = 7; // Th·ªùi gian b·∫£o v·ªá: 7 gi√¢y
    this.timeBar.clear();
    this.timeBar.fillStyle(0x388e3c);
    this.remainingTime = 7000; // 7 gi√¢y
    // timeBar.fillStyle(0x388e3c, 1); // M√†u xanh c·ªßa thanh th·ªùi gian
    this.player.fillColor = 0x388e3c; 

    const timerEvent = this.time.addEvent({
        delay: 1000, // 1 gi√¢y
        callback: () => {
            timeLeft--;
            this.timeBar.clear();
            this.timeBar.fillRect(this.player.x - 50, this.player.y - 60, 100 * (timeLeft / 7), 10); // C·∫≠p nh·∫≠t thanh th·ªùi gian

            if (timeLeft <= 0) {
                this.hasGi√°p = false; // H·∫øt th·ªùi gian b·∫£o v·ªá
                this.timeBar.clear();
                 // ƒê·ªïi l·∫°i m√†u g·ªëc nh√¢n v·∫≠t
                this.player.fillColor = 0x3498db
            }
        },
        callbackScope: this,
        loop: true
    });
}
            hitEnemy(bullet, enemy, aa) {
                bullet != 0 ? bullet.destroy(): 1; // X√≥a ƒë·∫°n khi ch·∫°m qu√°i
                let damage = 1
                aa != undefined ? damage = 5: 0; // S√°t th∆∞∆°ng ƒë·∫°n
                enemy.health -= damage; // Tr·ª´ m√°u qu√°i

                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã m√°u
                enemy.healthText.setText(`${enemy.health > 0 ? enemy.health : 0}`);

                // L√†m qu√°i ƒë·ª©ng im
                enemy.body.setVelocity(0, 0); // D·ª´ng ho√†n to√†n m·ªçi chuy·ªÉn ƒë·ªông c·ªßa qu√°i

                // Hi·ªáu ·ª©ng n·∫øu qu√°i c√≤n s·ªëng
                if (enemy.health > 0) {
                    this.tweens.add({
                        targets: enemy,
                        alpha: 0.5,
                        yoyo: true,
                        duration: 200
                    });
                } else {
                    if (enemy.pointDie > 0) {
                        enemy.pointDie--
                        
        // C·∫≠p nh·∫≠t s·ªë s·ª©c kh·ªèe n·∫øu c·∫ßn (v√≠ d·ª•: khi qu√°i v·∫≠t b·ªã t·∫•n c√¥ng)
            enemy.healthText.setText('DEAD');
            enemy.healthText.setStyle({ fill: 'red' });
                        this.createLootBox(enemy);
                        // Qu√°i ch·∫øt: hi·ªáu ·ª©ng nh·∫•p nh√°y tr∆∞·ªõc khi bi·∫øn m·∫•t
                        this.tweens.add({
                            targets: enemy,
                            alpha: 0,
                            duration: 1000, // Nh·∫•p nh√°y trong 1 gi√¢y
                            onComplete: () => {
                                this.enemies.remove(enemy);
                                enemy.destroy() // ·∫®n qu√°i
                                enemy.healthText.destroy()
                                // Lo·∫°i kh·ªèi nh√≥m enemies

                                // H·ªìi sinh qu√°i sau 5 gi√¢y
                                this.time.delayedCall(5000, () => {
                                    let newHealth = Phaser.Math.Between(1, 2); // M√°u ng·∫´u nhi√™n t·ª´ 2 ƒë·∫øn 17
                                    this.createEnemy(100, 100, newHealth);
                                });
                            }
                        });
                    }
                }
            }
            // H√†m ki·ªÉm tra v√† th√™m hi·ªáu ·ª©ng c·∫£nh b√°o n·∫øu s·ªë l∆∞·ª£ng m√≥n ƒë·ªì l√† 0
checkItemAlert = (item, count) => {
    const itemElement = document.getElementById(`${item}Count2`);
    if (count <= 0) {
        itemElement.classList.add('red-alert');
        // Sau 1 gi√¢y, x√≥a l·ªõp ƒë·ªÉ hi·ªáu ·ª©ng bi·∫øn m·∫•t
        setTimeout(() => {
            itemElement.classList.remove('red-alert');
        }, 1000);
    }
};

            createEnemy(x, y, health) {
                const enemy = this.add.circle(x, y, 20, 0x8e44ad); // M√†u n√¢u
                this.physics.add.existing(enemy);
                enemy.pointDie = 1

                enemy.body.setCollideWorldBounds(true);
                enemy.health = health;
                // enemy.setCollideWorldBounds(true);
                enemy.body.setBounce(1); // B·∫≠t l·∫°i khi va bi√™n

                const healthText = this.add.text(x, y - 30, `${enemy.health}`, { font: '16px Arial', fill: '#fff' });
                healthText.setOrigin(0.5);
                enemy.healthText = healthText;

                this.enemies.add(enemy);
            }



            createLeaf(type) {
                const color = type === 'green' ? 0x2ecc71 : type === 'yellow' ? 0xf1c40f : 0xe74c3c;
                const leaf = this.add.circle(
                    Phaser.Math.Between(20, 480),
                    Phaser.Math.Between(20, 480),
                    15,
                    color
                );
                this.physics.add.existing(leaf);
                leaf.type = type;

                this.leaves.add(leaf);
            }

            handleJoystickMove(pointer) {
                if (!pointer.isDown) return;

                let dx = pointer.x - this.joystickBase.x;
                let dy = pointer.y - this.joystickBase.y;
                let distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > 70) {
                    dx = (dx / distance) * 50;
                    dy = (dy / distance) * 50;
                }

                this.joystick.setPosition(this.joystickBase.x + dx, this.joystickBase.y + dy);

                let angle = Math.atan2(dy, dx);
                this.player.body.setVelocity(Math.cos(angle) * 100, Math.sin(angle) * 100);
            }

            resetJoystick() {
                this.joystick.setPosition(this.joystickBase.x, this.joystickBase.y);
                this.player.body.setVelocity(0, 0);
            }

            collectLeaf(player, leaf) {
                if (leaf.type === 'green') {
                    this.score += 1;
                    this.greenLeafCount++;
                    if (this.greenLeafCount === 6) {
                        this.createLeaf('red');
                        this.greenLeafCount = 0;
                    } else {
                        this.createLeaf('green');
                    }
                } else if (leaf.type === 'yellow') {
                    this.score += 1;
                } else if (leaf.type === 'red') {
                    this.score += 5;
                    this.createLeaf('green');
                }

                leaf.destroy();
                this.scoreText.setText(`${this.score}`);
            }

            updateTime() {
                this.totalSeconds++;
                const minutes = String(Math.floor(this.totalSeconds / 60)).padStart(2, '0');
                const seconds = String(this.totalSeconds % 60).padStart(2, '0');
                this.timeText.setText(`${minutes}:${seconds}`);
            }
        }

        const config = {
            type: Phaser.AUTO,
            // width: 500,
            // height: 500,
            width: window.innerWidth,  // L·∫•y chi·ªÅu r·ªông c·ªßa m√†n h√¨nh tr√¨nh duy·ªát
            height: window.innerHeight,  // L·∫•y chi·ªÅu cao c·ªßa m√†n h√¨nh tr√¨nh duy·ªát
            scene: MainScene,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            }
        };

        const game = new Phaser.Game(config);
        // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi k√≠ch th∆∞·ªõc c·ª≠a s·ªï ƒë·ªÉ ƒëi·ªÅu ch·ªânh l·∫°i k√≠ch th∆∞·ªõc game
        window.addEventListener('resize', () => {
            game.resize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>