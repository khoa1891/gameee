<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Game with Phaser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
    <style>
        /* T√πy ch·ªânh c√°c n√∫t b·∫Øn */
        .shoot-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px;
            font-size: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <button class="shoot-btn">Shoot</button>

    <script>
        class MainScene extends Phaser.Scene {
            constructor() {
                super('MainScene');
            }

            preload() {
                this.load.plugin(
                    'rexvirtualjoystickplugin',
                    'https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexvirtualjoystickplugin.min.js',
                    true
                );
            }

            create() {
                // T·∫°o b·∫£n ƒë·ªì (h√¨nh ch·ªØ nh·∫≠t)
                this.map = this.add.rectangle(0, 0, 500, 500, 0xffa500);
                this.map.setOrigin(0);
                this.physics.world.setBounds(0, 0, 500, 500);

                // T·∫°o ng∆∞·ªùi ch∆°i
                this.player = this.add.circle(250, 250, 20, 0x3498db);
                this.physics.add.existing(this.player);
                this.player.body.setCollideWorldBounds(true);

                // Nh√≥m l√°
                this.leaves = this.physics.add.group();
                this.createLeaf('green');

                // T·∫°o joystick
                this.joystickBase = this.add.circle(100, this.cameras.main.height - 100, 50, 0x000000, 0.3).setInteractive();
                this.joystick = this.add.circle(100, this.cameras.main.height - 100, 25, 0xffffff, 0.5).setInteractive();
                this.physics.add.overlap(this.player, this.leaves, this.collectLeaf, null, this);

                // Hi·ªÉn th·ªã ƒëi·ªÉm
                this.score = 0;
                this.greenLeafCount = 0;
                this.scoreText = this.add.text(this.player.x, this.player.y - 40, 'üü¢ 0', {
                    font: '24px Arial',
                    fill: '#000',
                }).setOrigin(0.5);

                // Th·ªùi gian
                this.totalSeconds = 0;
                this.timeText = this.add.text(this.cameras.main.width - 100, 10, '00:00', {
                    font: '24px Arial',
                    fill: '#000',
                }).setOrigin(1, 0);

                // ƒê·∫øm th·ªùi gian
                this.time.addEvent({
                    delay: 1000,
                    callback: this.updateTime,
                    callbackScope: this,
                    loop: true,
                });

                // L√° v√†ng xu·∫•t hi·ªán m·ªói 17 gi√¢y
                this.time.addEvent({
                    delay: 17000,
                    callback: () => this.createLeaf('yellow'),
                    loop: true,
                });

                // ƒêi·ªÅu khi·ªÉn joystick
                this.input.on('pointermove', this.handleJoystickMove, this);
                this.input.on('pointerup', this.resetJoystick, this);

                // T·∫°o qu√°i v·∫≠t
                this.enemies = this.physics.add.group();
                this.createEnemy(100, 100, 10);
                this.createEnemy(400, 200, 15);
                this.createEnemy(300, 350, 17);

                // N√∫t b·∫Øn
                this.shootBtn = document.querySelector('.shoot-btn');
                this.shootBtn.addEventListener('click', this.shoot.bind(this));

                // T·∫°o ƒë·∫°n
                this.bullets = this.physics.add.group({
                    classType: Phaser.GameObjects.Circle,
                    runChildUpdate: true,
                });
            }

            update() {
                this.scoreText.setPosition(this.player.x, this.player.y - 40);
            }

            shoot() {
                if (this.score <= 0) return; // Kh√¥ng b·∫Øn n·∫øu ƒëi·ªÉm = 0

                // T√¨m qu√°i v·∫≠t g·∫ßn nh·∫•t
                let closestEnemy = null;
                let minDistance = Infinity;

                this.enemies.getChildren().forEach(enemy => {
                    let distance = Phaser.Math.Distance.Between(this.player.x, this.player.y, enemy.x, enemy.y);
                    if (distance < minDistance && distance < 200) { // Ki·ªÉm tra kho·∫£ng c√°ch
                        minDistance = distance;
                        closestEnemy = enemy;
                    }
                });
                

                if (closestEnemy) {
                    let dx = closestEnemy.x - this.player.x;
                    let dy = closestEnemy.y - this.player.y;
                    let angle = Math.atan2(dy, dx);

                    // T·∫°o ƒë·∫°n
                    const bullet = this.bullets.get(this.player.x, this.player.y, 15, 0xffffff);
                    bullet.setVelocity(Math.cos(angle) * 300, Math.sin(angle) * 300);
                    this.score--; // Gi·∫£m ƒëi·ªÉm m·ªói l·∫ßn b·∫Øn
                }
            }

            createEnemy(x, y, health) {
                const enemy = this.add.circle(x, y, 20, 0x8e44ad); // M√†u n√¢u
                this.physics.add.existing(enemy);

                enemy.body.setCollideWorldBounds(true);
                enemy.health = health;

                const healthText = this.add.text(x, y - 30, `${enemy.health}`, { font: '16px Arial', fill: '#fff' });
                healthText.setOrigin(0.5);
                enemy.healthText = healthText;

                this.enemies.add(enemy);
            }

            updateBullet() {
                this.bullets.children.iterate(bullet => {
                    if (!bullet.active) return;

                    this.enemies.children.iterate(enemy => {
                        if (Phaser.Math.Distance.Between(bullet.x, bullet.y, enemy.x, enemy.y) < 20) {
                            this.hitEnemy(bullet, enemy);
                            bullet.setActive(false).setVisible(false); // X√≥a ƒë·∫°n
                        }
                    });
                });
            }

            hitEnemy(bullet, enemy) {
                let damage = 1;
                enemy.health -= damage;

                enemy.healthText.setText(`${enemy.health}`);

                this.tweens.add({
                    targets: enemy,
                    alpha: 0.5,
                    yoyo: true,
                    duration: 200,
                    onComplete: () => {
                        if (enemy.health <= 0) {
                            enemy.setActive(false).setVisible(false);
                            enemy.healthText.setVisible(false);
                        }
                    }
                });
            }

            createLeaf(type) {
                const color = type === 'green' ? 0x2ecc71 : type === 'yellow' ? 0xf1c40f : 0xe74c3c;
                const leaf = this.add.circle(
                    Phaser.Math.Between(20, 480),
                    Phaser.Math.Between(20, 480),
                    15,
                    color
                );
                this.physics.add.existing(leaf);
                leaf.type = type;

                this.leaves.add(leaf);
            }

            handleJoystickMove(pointer) {
                if (!pointer.isDown) return;

                let dx = pointer.x - this.joystickBase.x;
                let dy = pointer.y - this.joystickBase.y;
                let distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > 70) {
                    dx = (dx / distance) * 50;
                    dy = (dy / distance) * 50;
                }

                this.joystick.setPosition(this.joystickBase.x + dx, this.joystickBase.y + dy);

                let angle = Math.atan2(dy, dx);
                this.player.body.setVelocity(Math.cos(angle) * 100, Math.sin(angle) * 100);
            }

            resetJoystick() {
                this.joystick.setPosition(this.joystickBase.x, this.joystickBase.y);
                this.player.body.setVelocity(0, 0);
            }

            collectLeaf(player, leaf) {
                if (leaf.type === 'green') {
                    this.score += 1;
                    this.greenLeafCount++;
                    if (this.greenLeafCount === 6) {
                        this.createLeaf('red');
                        this.greenLeafCount = 0;
                    } else {
                        this.createLeaf('green');
                    }
                } else if (leaf.type === 'yellow') {
                    this.score += 1;
                } else if (leaf.type === 'red') {
                    this.score += 5;
                    this.createLeaf('green');
                }

                leaf.destroy();
                this.scoreText.setText(`${this.score}`);
            }

            updateTime() {
                this.totalSeconds++;
                const minutes = String(Math.floor(this.totalSeconds / 60)).padStart(2, '0');
                const seconds = String(this.totalSeconds % 60).padStart(2, '0');
                this.timeText.setText(`${minutes}:${seconds}`);
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            scene: MainScene,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            }
        };

        const game = new Phaser.Game(config);
    </script>
</body>

</html>
